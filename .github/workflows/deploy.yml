name: Build, Push & Deploy

# â”€â”€ Trigger â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Runs on every push to main (your normal git push workflow)
on:
  push:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: johanespao/asymptotic_zero

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# JOB 1 â€” Build the Docker image on GitHub's servers and push to ghcr.io
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
jobs:
  build-push:
    name: Build & Push Image
    runs-on: ubuntu-latest

    # These permissions allow the runner to push to ghcr.io using GITHUB_TOKEN.
    # No personal token needed for the push â€” only for the VPS pull (ASYMPTOTIC_GHCR_TOKEN).
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Log in to GitHub Container Registry using the built-in runner token.
      # GITHUB_TOKEN is automatically available â€” no secret needed for this step.
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      # Log in to Docker Hub to pull BuildX
      - name: Log in to Docker Hub   # â† ADD THIS
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Generates two tags:
      #   ghcr.io/johanespao/asymptotic_zero:latest   â† always overwritten on main
      #   ghcr.io/johanespao/asymptotic_zero:sha-<7>  â† immutable per commit
      - name: Extract image metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,format=short,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      # Buildx enables layer caching â€” subsequent builds after the first are much faster
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # The actual build. .dockerignore handles what is excluded (data/, az_env/, etc.)
      # checkpoints/best is included because it is committed to git.
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # Cache build layers in GitHub Actions cache â€” saves ~5 min on repeated builds
          cache-from: type=gha
          cache-to: type=gha,mode=max

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# JOB 2 â€” Deploy: run directly on server via self-hosted runner
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy:
    name: Deploy to VPS
    runs-on: self-hosted   # self-hosted runner is already on the VPS
    needs: build-push

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # â”€â”€ Step 1: Prepare folder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Prepare deployment folder
        run: |
          AZ_PATH="${{ secrets.SERVER_ASYMPTOTIC_PATH }}"
          mkdir -p "$AZ_PATH/logs"
          cp docker-compose.yml "$AZ_PATH/docker-compose.yml"
          echo "âœ… docker-compose.yml copied to $AZ_PATH"

      # â”€â”€ Step 2: Write .env â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Write .env
        run: |
          AZ_PATH="${{ secrets.SERVER_ASYMPTOTIC_PATH }}"
          {
            echo "SECRET_HOST=${{ secrets.SECRET_HOST }}"
            echo "PROJECT_ID=${{ secrets.PROJECT_ID }}"
            echo "CLIENT_ID=${{ secrets.CLIENT_ID }}"
            echo "CLIENT_SECRET=${{ secrets.CLIENT_SECRET }}"
            echo "ASYMPTOTIC_MODE=${{ secrets.ASYMPTOTIC_MODE }}"
            echo "ASYMPTOTIC_GHCR_TOKEN=${{ secrets.ASYMPTOTIC_GHCR_TOKEN }}"
          } > "$AZ_PATH/.env"
          chmod 600 "$AZ_PATH/.env"
          echo "âœ… .env written ($(wc -l < "$AZ_PATH/.env") vars)"

      # â”€â”€ Step 3: Write restart script â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Write restart script
        run: |
          AZ_PATH="${{ secrets.SERVER_ASYMPTOTIC_PATH }}"
          cat > "$AZ_PATH/az_restart.sh" << 'EOF'
          #!/bin/bash
          set -e
          AZ_PATH="__AZ_PATH__"
          GHCR_TOKEN=$(grep '^ASYMPTOTIC_GHCR_TOKEN=' "$AZ_PATH/.env" | cut -d '=' -f2-)
          echo "$GHCR_TOKEN" | docker login ghcr.io -u johanesPao --password-stdin
          cd "$AZ_PATH"
          docker compose pull
          docker compose up -d
          echo "$(date '+%Y-%m-%d %H:%M:%S') â€” Asymptotic Zero restarted" >> "$AZ_PATH/logs/restart.log"
          EOF

          sed -i "s|__AZ_PATH__|$AZ_PATH|g" "$AZ_PATH/az_restart.sh"
          chmod +x "$AZ_PATH/az_restart.sh"
          echo "âœ… az_restart.sh written"

      # â”€â”€ Step 4: GHCR login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Login to GHCR
        run: |
          AZ_PATH="${{ secrets.SERVER_ASYMPTOTIC_PATH }}"
          GHCR_TOKEN=$(grep '^ASYMPTOTIC_GHCR_TOKEN=' "$AZ_PATH/.env" | cut -d '=' -f2-)
          echo "$GHCR_TOKEN" | docker login ghcr.io -u johanesPao --password-stdin
          echo "âœ… ghcr.io login OK"

      # â”€â”€ Step 5: Start or schedule container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Start or schedule container restart
        run: |
          AZ_PATH="${{ secrets.SERVER_ASYMPTOTIC_PATH }}"
          if docker ps --format '{{.Names}}' | grep -q '^asymptotic_zero$'; then
            echo "ğŸ“¦ Container is running. Scheduling restart at 07:00 WIB (00:00 UTC)."
            # Remove previous at jobs
            atq | awk '{print $1}' | xargs -r atrm 2>/dev/null || true
            echo "$AZ_PATH/az_restart.sh >> $AZ_PATH/logs/restart.log 2>&1" | at 00:00
            echo "âœ… Restart scheduled. Pending at queue:"
            atq
          else
            echo "ğŸ“¦ Container is NOT running â€” starting immediately."
            cd "$AZ_PATH"
            docker compose pull
            docker compose up -d
            echo "âœ… Container started."
            docker ps --filter "name=asymptotic_zero" --format "table {{.Names}}\t{{.Status}}\t{{.Image}}"
