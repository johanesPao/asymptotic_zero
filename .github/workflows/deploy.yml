name: Build, Push & Deploy

# â”€â”€ Trigger â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Runs on every push to main
on:
  push:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: johanespao/asymptotic_zero

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# JOB 1 â€” Build the Docker image on GitHub's servers and push to ghcr.io
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
jobs:
  build-push:
    name: Build & Push Image
    runs-on: ubuntu-latest

    # Allow the runner to push packages to ghcr.io with the built-in GITHUB_TOKEN.
    # No personal token needed here â€” ASYMPTOTIC_GHCR_TOKEN is only for VPS pulls.
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Log in to ghcr.io using the runner's built-in token (no secret needed)
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Generates two tags per push:
      #   ghcr.io/johanespao/asymptotic_zero:latest   â† always the latest main build
      #   ghcr.io/johanespao/asymptotic_zero:sha-<7>  â† immutable snapshot per commit
      - name: Extract image metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,format=short,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      # Log in to Docker Hub to avoid anonymous pull rate limits on the shared runner.
      # setup-buildx-action pulls a small builder image from Docker Hub; without auth
      # it regularly hits the 100-pull/6h anonymous limit on GitHub's shared IP pool.
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Buildx enables layer caching â€” repeat builds are much faster
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build and push. .dockerignore handles exclusions (data/, az_env/, etc.)
      # checkpoints/best is committed to git so it is included automatically.
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # Cache layers in GitHub Actions cache â€” saves ~5â€“8 min on repeated builds
          cache-from: type=gha
          cache-to: type=gha,mode=max

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# JOB 2 â€” Deploy via self-hosted runner already on the VPS
#
# Why self-hosted instead of SSH?
#   The actions-runner is already installed on the VPS. Running the deploy job
#   directly on the VPS eliminates SSH key management entirely and is faster.
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy:
    name: Deploy to VPS
    runs-on: self-hosted
    needs: build-push

    steps:
      # â”€â”€ Step 1: Copy docker-compose.yml to deployment folder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare deployment folder
        run: |
          AZ_PATH="${{ secrets.SERVER_ASYMPTOTIC_PATH }}"
          mkdir -p "$AZ_PATH/logs"
          cp docker-compose.yml "$AZ_PATH/docker-compose.yml"
          echo "âœ… docker-compose.yml copied to $AZ_PATH"

      # â”€â”€ Step 2: Write .env from GitHub Secrets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # This file is read by docker-compose at container startup.
      # chmod 600 ensures only the current user can read it.
      - name: Write .env file
        run: |
          AZ_PATH="${{ secrets.SERVER_ASYMPTOTIC_PATH }}"
          # Using printf per-line avoids heredoc indentation issues
          {
            printf 'SECRET_HOST=%s\n'              '${{ secrets.SECRET_HOST }}'
            printf 'PROJECT_ID=%s\n'               '${{ secrets.PROJECT_ID }}'
            printf 'CLIENT_ID=%s\n'                '${{ secrets.CLIENT_ID }}'
            printf 'CLIENT_SECRET=%s\n'            '${{ secrets.CLIENT_SECRET }}'
            printf 'ASYMPTOTIC_MODE=%s\n'          '${{ secrets.ASYMPTOTIC_MODE }}'
            printf 'ASYMPTOTIC_GHCR_TOKEN=%s\n'   '${{ secrets.ASYMPTOTIC_GHCR_TOKEN }}'
          } > "$AZ_PATH/.env"
          chmod 600 "$AZ_PATH/.env"
          echo "âœ… .env written ($(wc -l < "$AZ_PATH/.env") lines)"

      # â”€â”€ Step 3: Write az_restart.sh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # This script is called by the at-job scheduler at 07:00 WIB.
      # It logs in to ghcr.io, pulls the latest image, and restarts the container.
      - name: Write restart script
        run: |
          AZ_PATH="${{ secrets.SERVER_ASYMPTOTIC_PATH }}"
          cat > "$AZ_PATH/az_restart.sh" << SCRIPTEOF
          #!/bin/bash
          set -euo pipefail

          AZ_PATH="$AZ_PATH"
          LOG="$AZ_PATH/logs/restart.log"

          echo "\$(date '+%Y-%m-%d %H:%M:%S') â€” Starting scheduled restart..." >> "\$LOG"

          # Read GHCR token from .env
          GHCR_TOKEN=\$(grep '^ASYMPTOTIC_GHCR_TOKEN=' "\$AZ_PATH/.env" | cut -d '=' -f2-)
          if [ -z "\$GHCR_TOKEN" ]; then
            echo "\$(date '+%Y-%m-%d %H:%M:%S') â€” ERROR: ASYMPTOTIC_GHCR_TOKEN not found in .env" >> "\$LOG"
            exit 1
          fi

          # Login to ghcr.io
          echo "\$GHCR_TOKEN" | docker login ghcr.io -u johanesPao --password-stdin >> "\$LOG" 2>&1

          # Pull latest image and restart
          cd "\$AZ_PATH"
          docker compose pull >> "\$LOG" 2>&1
          docker compose up -d >> "\$LOG" 2>&1

          echo "\$(date '+%Y-%m-%d %H:%M:%S') â€” Restart complete." >> "\$LOG"
          SCRIPTEOF

          chmod +x "$AZ_PATH/az_restart.sh"
          echo "âœ… az_restart.sh written and made executable"

      # â”€â”€ Step 4: Log in to ghcr.io on VPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Login to GHCR on VPS
        run: |
          AZ_PATH="${{ secrets.SERVER_ASYMPTOTIC_PATH }}"
          GHCR_TOKEN=$(grep '^ASYMPTOTIC_GHCR_TOKEN=' "$AZ_PATH/.env" | cut -d '=' -f2-)
          echo "$GHCR_TOKEN" | docker login ghcr.io -u johanesPao --password-stdin
          echo "âœ… ghcr.io login OK"

      # â”€â”€ Step 5: Start container now, or schedule 07:00 WIB restart â”€â”€â”€â”€â”€â”€â”€â”€
      #
      # 07:00 WIB  =  00:00 UTC  (WIB is UTC+7)
      #
      # If the container is already running:
      #   â†’ schedule a one-time at-job for 00:00 UTC so the bot runs its full
      #     trading day and cleanly switches to the new image tonight.
      # If the container is NOT running:
      #   â†’ start it immediately (no need to wait).
      #
      # atq is cleared first so multiple deploys on the same day don't stack up.
      - name: Start or schedule container restart
        run: |
          AZ_PATH="${{ secrets.SERVER_ASYMPTOTIC_PATH }}"

          if docker ps --format '{{.Names}}' | grep -q '^asymptotic_zero$'; then
            echo "ğŸ“¦ Container is RUNNING â€” scheduling restart at 07:00 WIB (00:00 UTC)."

            # Remove any previously scheduled az restart jobs
            atq | awk '{print $1}' | xargs -r atrm 2>/dev/null || true
            echo "  Old at-jobs cleared."

            # Schedule the restart
            echo "bash $AZ_PATH/az_restart.sh >> $AZ_PATH/logs/restart.log 2>&1" | at 00:00

            echo "âœ… Restart scheduled. Pending at-queue:"
            atq
          else
            echo "ğŸ“¦ Container is NOT running â€” starting immediately."
            cd "$AZ_PATH"
            docker compose pull
            docker compose up -d
            echo "âœ… Container started."
            docker ps --filter "name=asymptotic_zero" --format "table {{.Names}}\t{{.Status}}\t{{.Image}}"
          fi
